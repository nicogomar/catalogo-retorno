<div class="p-0 bg-gray-100">
  <!-- Header con acciones -->
  <div
    class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6 p-6 bg-white rounded-lg shadow-sm"
  >
    <div class="flex-1">
      <h2 class="text-2xl md:text-3xl font-semibold text-primary mb-2">
        Galería de Imágenes
      </h2>
      <p class="text-sm text-gray-600">
        {{ filteredImages.length }} imagen(es) en el bucket
        <span *ngIf="bucketStats" class="text-primary font-medium">
          - {{ bucketStats.totalSizeMB }} MB usados
        </span>
      </p>
    </div>
    <div class="flex gap-3 w-full md:w-auto">
      <button
        class="flex-1 md:flex-none px-6 py-3 bg-primary text-white rounded-lg font-medium hover:bg-primary-dark transition-all shadow-sm hover:shadow-md hover:-translate-y-0.5"
        (click)="openUploadModal()"
      >
        <span>📤 Subir Imagen</span>
      </button>
      <button
        class="flex-1 md:flex-none px-6 py-3 rounded-lg font-medium transition-all"
        [ngClass]="
          selectMode
            ? 'bg-primary text-white'
            : 'bg-gray-200 text-gray-800 hover:bg-gray-300'
        "
        (click)="toggleSelectMode()"
      >
        <span>{{ selectMode ? "✓ Modo Selección" : "☑️ Seleccionar" }}</span>
      </button>
    </div>
  </div>

  <!-- Barra de herramientas -->
  <div
    class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-5 p-4 bg-white rounded-lg shadow-sm"
  >
    <div class="flex-1 w-full md:w-auto">
      <div class="relative max-w-md">
        <input
          type="text"
          placeholder="Buscar imágenes..."
          [(ngModel)]="searchTerm"
          (input)="onSearchChange($event)"
          class="w-full px-4 py-2.5 pr-10 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary"
        />
        <span
          class="absolute right-3 top-1/2 -translate-y-1/2 text-lg text-gray-400"
          >🔍</span
        >
      </div>
    </div>

    <div class="flex items-center gap-2 flex-wrap w-full md:w-auto">
      <label class="text-sm font-medium text-gray-600 mr-2">Ordenar por:</label>
      <button
        class="px-4 py-2 bg-gray-100 border border-gray-300 rounded-lg text-sm hover:bg-gray-200 transition-colors"
        [ngClass]="
          sortBy === 'date'
            ? 'bg-primary text-white border-primary hover:bg-primary-dark'
            : ''
        "
        (click)="changeSortBy('date')"
      >
        Fecha
        <span *ngIf="sortBy === 'date'">
          {{ sortOrder === "asc" ? "↑" : "↓" }}
        </span>
      </button>
      <button
        class="px-4 py-2 bg-gray-100 border border-gray-300 rounded-lg text-sm hover:bg-gray-200 transition-colors"
        [ngClass]="
          sortBy === 'name'
            ? 'bg-primary text-white border-primary hover:bg-primary-dark'
            : ''
        "
        (click)="changeSortBy('name')"
      >
        Nombre
        <span *ngIf="sortBy === 'name'">
          {{ sortOrder === "asc" ? "↑" : "↓" }}
        </span>
      </button>
      <button
        class="px-4 py-2 bg-gray-100 border border-gray-300 rounded-lg text-sm hover:bg-gray-200 transition-colors"
        [ngClass]="
          sortBy === 'size'
            ? 'bg-primary text-white border-primary hover:bg-primary-dark'
            : ''
        "
        (click)="changeSortBy('size')"
      >
        Tamaño
        <span *ngIf="sortBy === 'size'">
          {{ sortOrder === "asc" ? "↑" : "↓" }}
        </span>
      </button>
    </div>
  </div>

  <!-- Acciones de selección múltiple -->
  <div
    class="flex flex-col md:flex-row justify-between items-start md:items-center gap-3 p-4 bg-blue-50 border border-blue-200 rounded-lg mb-5"
    *ngIf="selectMode"
  >
    <div class="text-blue-700 font-medium">
      <span>{{ selectedImages.size }} imagen(es) seleccionada(s)</span>
    </div>
    <div class="flex gap-3 items-center w-full md:w-auto flex-col md:flex-row">
      <button
        class="text-primary underline hover:text-primary-dark px-3 py-2 text-sm"
        (click)="selectAllImages()"
      >
        Seleccionar todas
      </button>
      <button
        class="text-primary underline hover:text-primary-dark px-3 py-2 text-sm"
        (click)="deselectAllImages()"
      >
        Deseleccionar todas
      </button>
      <button
        class="w-full md:w-auto px-5 py-2.5 bg-red-600 text-white rounded-lg text-sm font-medium hover:bg-red-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition-all"
        (click)="deleteSelectedImages()"
        [disabled]="selectedImages.size === 0"
      >
        🗑️ Eliminar seleccionadas
      </button>
    </div>
  </div>

  <!-- Loading State -->
  <div
    class="flex flex-col items-center justify-center p-20 bg-white rounded-lg shadow-sm"
    *ngIf="isLoading"
  >
    <div
      class="w-12 h-12 border-4 border-gray-200 border-t-primary rounded-full animate-spin mb-5"
    ></div>
    <p class="text-gray-600">Cargando imágenes...</p>
  </div>

  <!-- Error State -->
  <div
    class="flex flex-col items-center justify-center p-20 bg-white rounded-lg shadow-sm"
    *ngIf="loadError && !isLoading"
  >
    <p class="text-red-600 mb-5 text-center">{{ loadError }}</p>
    <button
      class="px-6 py-3 bg-primary text-white rounded-lg hover:bg-primary-dark transition-colors"
      (click)="loadImages()"
    >
      Reintentar
    </button>
  </div>

  <!-- Empty State -->
  <div
    class="flex flex-col items-center justify-center p-20 bg-white rounded-lg shadow-sm text-center"
    *ngIf="
      !isLoading &&
      !loadError &&
      filteredImages.length === 0 &&
      images.length === 0
    "
  >
    <div class="text-8xl mb-5 opacity-50">🖼️</div>
    <h3 class="text-2xl font-semibold text-gray-800 mb-3">No hay imágenes</h3>
    <p class="text-gray-600 mb-6">
      Comienza subiendo tu primera imagen al bucket.
    </p>
    <button
      class="px-6 py-3 bg-primary text-white rounded-lg hover:bg-primary-dark transition-colors shadow-sm"
      (click)="openUploadModal()"
    >
      Subir primera imagen
    </button>
  </div>

  <!-- No Results State -->
  <div
    class="flex flex-col items-center justify-center p-20 bg-white rounded-lg shadow-sm text-center"
    *ngIf="
      !isLoading &&
      !loadError &&
      filteredImages.length === 0 &&
      images.length > 0
    "
  >
    <div class="text-8xl mb-5 opacity-50">🔍</div>
    <h3 class="text-2xl font-semibold text-gray-800 mb-3">
      No se encontraron resultados
    </h3>
    <p class="text-gray-600">Intenta con otros términos de búsqueda.</p>
  </div>

  <!-- Grid de Imágenes -->
  <div
    class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-5"
    *ngIf="!isLoading && !loadError && filteredImages.length > 0"
  >
    <div
      class="bg-white rounded-lg overflow-hidden shadow-sm hover:shadow-lg hover:-translate-y-1 transition-all cursor-pointer"
      [ngClass]="
        isImageSelected(image) ? 'ring-4 ring-primary ring-opacity-40' : ''
      "
      *ngFor="let image of filteredImages"
      (click)="previewImageModal(image)"
    >
      <div class="relative w-full h-56 overflow-hidden bg-gray-100">
        <img
          [src]="image.url"
          [alt]="image.name"
          (error)="onImageError($event)"
          class="w-full h-full object-cover transition-transform hover:scale-105"
        />
        <div
          class="absolute inset-0 bg-black bg-opacity-30 flex items-center justify-center"
          *ngIf="selectMode"
        >
          <div class="bg-white rounded p-1">
            <input
              type="checkbox"
              [checked]="isImageSelected(image)"
              (click)="$event.stopPropagation(); toggleImageSelection(image)"
              class="w-6 h-6 cursor-pointer"
            />
          </div>
        </div>
      </div>
      <div class="p-4">
        <h4
          class="text-base font-semibold text-gray-800 mb-2 truncate"
          [title]="image.name"
        >
          {{ image.name }}
        </h4>
        <div class="flex flex-col gap-1 text-sm text-gray-600">
          <span>📅 {{ formatDate(image.created_at) }}</span>
          <span *ngIf="image.metadata?.size"
            >💾 {{ formatSize(image.metadata?.size ?? 0) }}</span
          >
        </div>
      </div>
      <div
        class="flex justify-around p-3 border-t border-gray-200 bg-gray-50"
        *ngIf="!selectMode"
      >
        <button
          class="p-2 text-xl hover:bg-gray-200 rounded-lg transition-all hover:scale-110"
          (click)="$event.stopPropagation(); copyImageUrl(image)"
          title="Copiar URL"
        >
          📋
        </button>
        <button
          class="p-2 text-xl hover:bg-gray-200 rounded-lg transition-all hover:scale-110"
          (click)="$event.stopPropagation(); downloadImage(image)"
          title="Descargar"
        >
          ⬇️
        </button>
        <button
          class="p-2 text-xl hover:bg-red-50 rounded-lg transition-all hover:scale-110"
          (click)="$event.stopPropagation(); confirmDelete(image)"
          title="Eliminar"
        >
          🗑️
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal de Subida -->
<div
  class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[1000] animate-[fadeIn_0.3s_ease]"
  *ngIf="showUploadModal"
  (click)="closeUploadModal()"
>
  <div
    class="bg-white rounded-xl w-[90%] max-w-2xl max-h-[90vh] overflow-y-auto shadow-2xl animate-[slideUp_0.3s_ease]"
    (click)="$event.stopPropagation()"
  >
    <div class="flex justify-between items-center p-6 border-b border-gray-200">
      <h2 class="text-2xl font-semibold text-primary">Subir Nueva Imagen</h2>
      <button
        class="w-8 h-8 flex items-center justify-center text-gray-400 hover:bg-gray-100 hover:text-gray-800 rounded transition-colors text-3xl"
        (click)="closeUploadModal()"
      >
        ✕
      </button>
    </div>
    <div class="p-8">
      <div class="mb-5">
        <input
          type="file"
          id="file-input"
          accept="image/*"
          (change)="onFileSelected($event)"
          [disabled]="isUploading"
          class="hidden"
        />
        <label
          for="file-input"
          class="block p-10 border-2 border-dashed border-gray-300 rounded-lg text-center cursor-pointer bg-gray-50 hover:border-primary hover:bg-beige-light transition-colors"
        >
          <div class="text-5xl mb-4">📤</div>
          <p *ngIf="!selectedFile" class="text-gray-700">
            <strong class="text-primary">Click para seleccionar</strong> o
            arrastra una imagen aquí
          </p>
          <p *ngIf="selectedFile" class="text-primary">
            <strong>Archivo seleccionado:</strong><br />
            {{ selectedFile.name }} ({{ formatSize(selectedFile.size) }})
          </p>
          <p class="text-xs text-gray-500 mt-3">
            Formatos: JPEG, PNG, GIF, WebP | Tamaño máximo: 5MB
          </p>
        </label>
      </div>

      <div class="mt-5" *ngIf="isUploading">
        <div class="w-full h-2 bg-gray-200 rounded overflow-hidden mb-2">
          <div
            class="h-full bg-primary transition-all duration-300"
            [style.width.%]="uploadProgress"
          ></div>
        </div>
        <p class="text-center text-gray-600 text-sm">
          Subiendo... {{ uploadProgress }}%
        </p>
      </div>
    </div>
    <div
      class="flex justify-end gap-3 p-5 border-t border-gray-200 bg-gray-50 rounded-b-xl"
    >
      <button
        class="px-6 py-3 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition-colors disabled:opacity-50"
        (click)="closeUploadModal()"
        [disabled]="isUploading"
      >
        Cancelar
      </button>
      <button
        class="px-6 py-3 bg-primary text-white rounded-lg hover:bg-primary-dark transition-colors disabled:bg-gray-300 disabled:cursor-not-allowed shadow-sm"
        (click)="uploadImage()"
        [disabled]="!selectedFile || isUploading"
      >
        {{ isUploading ? "Subiendo..." : "Subir Imagen" }}
      </button>
    </div>
  </div>
</div>

<!-- Modal de Confirmación de Eliminación -->
<div
  class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[1000] animate-[fadeIn_0.3s_ease]"
  *ngIf="showDeleteModal"
  (click)="closeDeleteModal()"
>
  <div
    class="bg-white rounded-xl w-[90%] max-w-md max-h-[90vh] overflow-y-auto shadow-2xl animate-[slideUp_0.3s_ease]"
    (click)="$event.stopPropagation()"
  >
    <div class="flex justify-between items-center p-6 border-b border-gray-200">
      <h2 class="text-2xl font-semibold text-primary">Confirmar Eliminación</h2>
    </div>
    <div class="p-8">
      <p class="mb-4 text-gray-700 leading-relaxed">
        ¿Estás seguro que deseas eliminar la imagen
        <strong>{{ imageToDelete?.name }}</strong
        >?
      </p>
      <p class="text-red-600 font-medium text-sm">
        Esta acción no se puede deshacer.
      </p>
    </div>
    <div
      class="flex justify-end gap-3 p-5 border-t border-gray-200 bg-gray-50 rounded-b-xl"
    >
      <button
        class="px-6 py-3 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition-colors"
        (click)="closeDeleteModal()"
      >
        Cancelar
      </button>
      <button
        class="px-6 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors"
        (click)="deleteImage()"
      >
        Eliminar
      </button>
    </div>
  </div>
</div>

<!-- Modal de Vista Previa -->
<div
  class="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-[1000] animate-[fadeIn_0.3s_ease]"
  *ngIf="showImagePreview"
  (click)="closeImagePreview()"
>
  <div
    class="bg-white rounded-xl w-[90%] max-w-4xl max-h-[90vh] overflow-y-auto relative animate-[slideUp_0.3s_ease]"
    (click)="$event.stopPropagation()"
  >
    <button
      class="absolute top-4 right-4 w-10 h-10 bg-black bg-opacity-50 text-white text-3xl rounded-full flex items-center justify-center hover:bg-opacity-70 transition-colors z-10"
      (click)="closeImagePreview()"
    >
      ✕
    </button>
    <div
      class="w-full max-h-[60vh] flex items-center justify-center bg-black rounded-t-xl overflow-hidden"
    >
      <img
        [src]="previewImage?.url"
        [alt]="previewImage?.name"
        (error)="onImageError($event)"
        class="max-w-full max-h-[60vh] object-contain"
      />
    </div>
    <div class="p-8 bg-white rounded-b-xl">
      <h3 class="text-xl font-semibold text-primary mb-4 break-all">
        {{ previewImage?.name }}
      </h3>
      <div class="flex gap-5 mb-5 text-sm text-gray-600">
        <span>📅 {{ formatDate(previewImage?.created_at || "") }}</span>
        <span *ngIf="previewImage?.metadata?.size">
          💾 {{ formatSize(previewImage?.metadata?.size ?? 0) }}
        </span>
      </div>
      <div class="flex gap-3 flex-wrap">
        <button
          class="flex-1 px-5 py-3 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition-colors"
          (click)="copyImageUrl(previewImage!)"
        >
          📋 Copiar URL
        </button>
        <button
          class="flex-1 px-5 py-3 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition-colors"
          (click)="downloadImage(previewImage!)"
        >
          ⬇️ Descargar
        </button>
        <button
          class="flex-1 px-5 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors"
          (click)="confirmDelete(previewImage!); closeImagePreview()"
        >
          🗑️ Eliminar
        </button>
      </div>
    </div>
  </div>
</div>
