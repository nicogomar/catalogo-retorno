<div class="admin-container">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-header">
      <h2>Admin Panel</h2>
    </div>
    <nav class="sidebar-nav">
      <a
        class="nav-item"
        [class.active]="currentSection === 'inicio'"
        (click)="changeSection('inicio')"
      >
        <i class="icon">🏠</i>
        <span>Inicio</span>
      </a>
      <a
        class="nav-item"
        [class.active]="currentSection === 'productos'"
        (click)="changeSection('productos')"
      >
        <i class="icon">📦</i>
        <span>Productos</span>
      </a>
      <a
        class="nav-item"
        [class.active]="currentSection === 'mensajes'"
        (click)="changeSection('mensajes')"
      >
        <i class="icon">💬</i>
        <span>Mensajes</span>
      </a>
      <a
        class="nav-item"
        [class.active]="currentSection === 'pedidos'"
        (click)="changeSection('pedidos')"
      >
        <i class="icon">🛒</i>
        <span>Pedidos</span>
      </a>
      <a
        class="nav-item"
        [class.active]="currentSection === 'imagenes'"
        (click)="changeSection('imagenes')"
      >
        <i class="icon">🖼️</i>
        <span>Imágenes</span>
      </a>
    </nav>
    <div class="sidebar-footer">
      <a routerLink="/" class="back-link">
        <i class="icon">↩️</i>
        <span>Volver al catálogo</span>
      </a>
    </div>
  </aside>

  <!-- Main Content -->
  <main class="main-content">
    <div class="content-header">
      <h1>{{ getSectionTitle() }}</h1>
    </div>

    <!-- Inicio Section -->
    <div class="content-body" *ngIf="currentSection === 'inicio'">
      <div class="welcome-card">
        <h2>Bienvenido al Panel de Administración</h2>
        <p>
          Desde aquí podrás gestionar todos los aspectos de tu catálogo de
          productos.
        </p>
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon">📦</div>
          <div class="stat-info">
            <h3>Productos</h3>
            <p class="stat-number">{{ productos.length }}</p>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">💬</div>
          <div class="stat-info">
            <h3>Mensajes</h3>
            <p class="stat-number">--</p>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">🛒</div>
          <div class="stat-info">
            <h3>Pedidos</h3>
            <p class="stat-number">--</p>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">🖼️</div>
          <div class="stat-info">
            <h3>Imágenes</h3>
            <p class="stat-number">--</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Productos Section -->
    <div class="content-body" *ngIf="currentSection === 'productos'">
      <div class="section-actions">
        <button class="btn-primary" (click)="openProductModal()">
          <span>+ Nuevo Producto</span>
        </button>
      </div>

      @if (isLoading) {
        <div class="loading-container">
          <div class="loading-spinner"></div>
          <p>Cargando productos...</p>
        </div>
      }

      @if (loadError) {
        <div class="error-container">
          <p class="error-message">{{ loadError }}</p>
          <button class="retry-button" (click)="loadProductos()">
            Reintentar
          </button>
        </div>
      }

      @if (!isLoading && !loadError) {
        <div class="products-table-container">
          @if (productos.length === 0) {
            <div class="no-products">
              <p>No hay productos registrados.</p>
              <button class="btn-primary" (click)="openProductModal()">
                Agregar primer producto
              </button>
            </div>
          } @else {
            <div class="products-grid">
              @for (producto of productos; track producto.id) {
                <div class="product-card-admin">
                  <div class="product-image-section">
                    <img
                      [src]="
                        producto.img_url || 'assets/img/default-product.jpg'
                      "
                      [alt]="producto.nombre || 'Producto'"
                      (error)="onImageError($event)"
                    />
                  </div>
                  <div class="product-info-section">
                    <h3 class="product-title">{{ producto.nombre }}</h3>
                    <div class="product-details">
                      <span class="detail-item">
                        <strong>Peso:</strong> {{ producto.peso }}
                      </span>
                      <span class="detail-item">
                        <strong>Precio:</strong> ${{ producto.precio }}
                      </span>
                    </div>
                    @if (producto.descripcion) {
                      <p class="product-description">
                        {{ producto.descripcion }}
                      </p>
                    }
                  </div>
                  <div class="product-actions">
                    <button
                      class="btn-edit"
                      (click)="editProducto(producto)"
                      title="Editar producto"
                    >
                      ✏️ Editar
                    </button>
                    <button
                      class="btn-delete"
                      (click)="confirmDelete(producto)"
                      title="Eliminar producto"
                    >
                      🗑️ Eliminar
                    </button>
                  </div>
                </div>
              }
            </div>
          }
        </div>
      }
    </div>

    <!-- Mensajes Section -->
    <div class="content-body" *ngIf="currentSection === 'mensajes'">
      <div class="data-card">
        <h3>Mensajes Recibidos</h3>
        <p>Visualiza y gestiona los mensajes de tus clientes.</p>
        <div class="placeholder-content">
          <p>Funcionalidad de mensajes próximamente...</p>
        </div>
      </div>
    </div>

    <!-- Pedidos Section -->
    <div class="content-body" *ngIf="currentSection === 'pedidos'">
      <div class="section-actions">
        <button class="btn-primary" (click)="loadPedidos()">
          <span>🔄 Actualizar</span>
        </button>
      </div>

      <!-- Filtros de Estado -->
      @if (!isPedidosLoading && !pedidosLoadError && pedidos.length > 0) {
        <div class="filtros-estado">
          <button
            class="btn-filtro"
            [class.active]="filtroEstadoPedido === 'Todos'"
            (click)="cambiarFiltroPedido('Todos')"
          >
            📋 Todos
          </button>
          <button
            class="btn-filtro"
            [class.active]="filtroEstadoPedido === 'Pendiente'"
            (click)="cambiarFiltroPedido('Pendiente')"
          >
            ⏳ Pendientes
          </button>
          <button
            class="btn-filtro"
            [class.active]="filtroEstadoPedido === 'Aprobado'"
            (click)="cambiarFiltroPedido('Aprobado')"
          >
            ✅ Aprobados
          </button>
          <button
            class="btn-filtro"
            [class.active]="filtroEstadoPedido === 'En curso'"
            (click)="cambiarFiltroPedido('En curso')"
          >
            🚚 En curso
          </button>
          <button
            class="btn-filtro"
            [class.active]="filtroEstadoPedido === 'Finalizado'"
            (click)="cambiarFiltroPedido('Finalizado')"
          >
            ✔️ Finalizados
          </button>
        </div>

        <!-- Filtros de Búsqueda -->
        <div class="filtros-busqueda">
          <div class="filtro-input-group">
            <label for="filtroId">🔍 ID Pedido:</label>
            <input
              type="text"
              id="filtroId"
              [(ngModel)]="filtroPedidoId"
              placeholder="Buscar por ID..."
              class="filtro-input"
            />
          </div>
          <div class="filtro-input-group">
            <label for="filtroComercio">🏪 Comercio:</label>
            <input
              type="text"
              id="filtroComercio"
              [(ngModel)]="filtroPedidoComercio"
              placeholder="Buscar por comercio..."
              class="filtro-input"
            />
          </div>
          <div class="filtro-input-group">
            <label for="filtroTelefono">📞 Teléfono:</label>
            <input
              type="text"
              id="filtroTelefono"
              [(ngModel)]="filtroPedidoTelefono"
              placeholder="Buscar por teléfono..."
              class="filtro-input"
            />
          </div>
          <div class="filtro-input-group">
            <label for="filtroFecha">📅 Fecha:</label>
            <input
              type="text"
              id="filtroFecha"
              [(ngModel)]="filtroPedidoFecha"
              placeholder="Buscar por fecha..."
              class="filtro-input"
            />
          </div>
          <div class="filtro-input-group">
            <button
              class="btn-limpiar-filtros"
              (click)="limpiarFiltrosPedidos()"
            >
              🗑️ Limpiar Filtros
            </button>
          </div>
        </div>
      }

      @if (isPedidosLoading) {
        <div class="loading-container">
          <div class="loading-spinner"></div>
          <p>Cargando pedidos...</p>
        </div>
      }

      @if (pedidosLoadError) {
        <div class="error-container">
          <p class="error-message">{{ pedidosLoadError }}</p>
          <button class="retry-button" (click)="loadPedidos()">
            Reintentar
          </button>
        </div>
      }

      @if (!isPedidosLoading && !pedidosLoadError) {
        <div class="pedidos-table-container">
          @if (pedidos.length === 0) {
            <div class="no-products">
              <p>No hay pedidos registrados.</p>
            </div>
          } @else {
            <div class="table-responsive">
              <table class="pedidos-table">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Fecha</th>
                    <th>Comercio</th>
                    <th>Localidad</th>
                    <th>Teléfono</th>
                    <th>Email</th>
                    <th>Productos</th>
                    <th>Total</th>
                    <th>Estado</th>
                  </tr>
                </thead>
                <tbody>
                  @for (pedido of getPedidosFiltrados(); track pedido.id) {
                    <tr>
                      <td class="td-id">{{ pedido.id }}</td>
                      <td class="td-fecha">
                        {{ formatDate(pedido.created_at) }}
                      </td>
                      <td class="td-comercio">
                        {{ pedido.nombre_comercio || "N/A" }}
                      </td>
                      <td class="td-localidad">
                        {{ pedido.localidad || "N/A" }}
                      </td>
                      <td class="td-telefono">
                        {{ pedido["telefóno"] || "N/A" }}
                      </td>
                      <td class="td-email">{{ pedido.email || "N/A" }}</td>
                      <td class="productos-cell">
                        @if (pedido.productos && pedido.productos.length > 0) {
                          <button
                            class="btn-ver-productos"
                            (click)="verProductosPedido(pedido)"
                          >
                            Ver ({{ pedido.productos.length }})
                          </button>
                        } @else {
                          <span class="text-muted">Sin productos</span>
                        }
                      </td>
                      <td class="td-total">
                        <strong>${{ calcularTotalPedido(pedido) }}</strong>
                      </td>
                      <td class="td-estado">
                        <select
                          class="estado-select"
                          [ngClass]="getEstadoClass(pedido.estado)"
                          [(ngModel)]="pedido.estado"
                          (ngModelChange)="cambiarEstadoPedido(pedido, $event)"
                        >
                          @for (estado of estadosDisponibles; track estado) {
                            <option [value]="estado">{{ estado }}</option>
                          }
                        </select>
                      </td>
                    </tr>
                  }
                </tbody>
              </table>
            </div>
          }
        </div>
      }
    </div>

    <!-- Imágenes Section -->
    <div class="content-body" *ngIf="currentSection === 'imagenes'">
      <app-image-gallery></app-image-gallery>
    </div>
  </main>
</div>

<!-- Modal de Productos del Pedido -->
@if (showProductosModal) {
  <div class="modal-overlay" (click)="closeProductosModal()">
    <div
      class="modal-content productos-modal"
      (click)="$event.stopPropagation()"
    >
      <div class="modal-header">
        <h2>Productos del Pedido</h2>
        <button class="close-button" (click)="closeProductosModal()">×</button>
      </div>
      <div class="modal-body">
        @if (selectedPedidoProductos.length === 0) {
          <p class="no-products-text">No hay productos en este pedido.</p>
        } @else {
          <div class="productos-modal-list">
            @for (producto of selectedPedidoProductos; track producto.id) {
              <div class="producto-modal-item">
                @if (producto.img_url || producto.image) {
                  <img
                    [src]="producto.img_url || producto.image"
                    [alt]="producto.nombre || producto.name"
                    class="producto-modal-imagen"
                    (error)="onImageError($event)"
                  />
                }
                <div class="producto-modal-info">
                  <h3 class="producto-modal-nombre">
                    {{ producto.nombre || producto.name }}
                  </h3>
                  @if (producto.peso || producto.weight) {
                    <p class="producto-modal-peso">
                      {{ producto.peso || producto.weight }}
                    </p>
                  }
                  <div class="producto-modal-detalles">
                    <span class="producto-modal-cantidad"
                      >Cantidad: {{ producto.quantity }}</span
                    >
                    <span class="producto-modal-precio-unitario">
                      Precio unitario: ${{
                        producto.precio || producto.priceNumeric
                      }}
                    </span>
                  </div>
                </div>
                <div class="producto-modal-total">
                  <strong
                    >${{
                      (producto.precio || producto.priceNumeric) *
                        producto.quantity
                    }}</strong
                  >
                </div>
              </div>
            }
          </div>
          <div class="modal-footer">
            <div class="total-pedido">
              <span class="total-label">Total del Pedido:</span>
              <span class="total-amount"
                >${{ calcularTotalProductos(selectedPedidoProductos) }}</span
              >
            </div>
          </div>
        }
      </div>
    </div>
  </div>
}

<!-- Product Modal -->
@if (showProductModal) {
  <app-product-modal
    [product]="selectedProduct"
    (close)="closeProductModal()"
    (save)="saveProducto($event)"
  />
}

<!-- Delete Confirmation Modal -->
@if (showDeleteModal) {
  <div class="modal-overlay" (click)="closeDeleteModal()">
    <div class="modal-content modal-small" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Confirmar Eliminación</h2>
      </div>
      <div class="modal-body">
        <p>
          ¿Estás seguro que deseas eliminar el producto
          <strong>{{ productToDelete?.nombre }}</strong
          >?
        </p>
        <p class="warning-text">Esta acción no se puede deshacer.</p>
      </div>
      <div class="modal-footer">
        <button class="btn-secondary" (click)="closeDeleteModal()">
          Cancelar
        </button>
        <button class="btn-delete" (click)="deleteProducto()">Eliminar</button>
      </div>
    </div>
  </div>
}
